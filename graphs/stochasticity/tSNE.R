
# Functions
source("functions/packages.R")
source("functions/gazetteer.R")
source("functions/tSNE3DGraph.R")


# Ensure that the required packages are available
packages()


# Data
principals <- fread(file = "../../warehouse/baseline/principals.csv", header = TRUE, encoding = "UTF-8", data.table = TRUE, 
                    colClasses = c("character", "numeric", "numeric", "numeric", "numeric", "factor"))
trainingdata <- data.matrix(principals[, !c("COUNTYGEOID", "label")], rownames.force = NA)
gazetteer <- gazetteer()


# Option
distances <- dist(trainingdata, method = "euclidean", diag = FALSE, upper = FALSE)


# Label colours
colours <- c('#000000', '#BF382A', '#0C4B8E', '#808000', '#993300', '#ff9900')


# Variables: Initial number of 'dimensionality reduction' feature space projections
variables <- as.list(c(8, 200, Sys.time()))
names(variables) <- c("initial_dims", "epoch", "start")


# Directory
pathstr <- file.path(getwd(), 'data')
if (dir.exists(paths = pathstr)) {
  base::unlink(pathstr, recursive = TRUE)
}
dir.create(path = pathstr, showWarnings = TRUE, recursive = TRUE)


# Structuring
structure <- function(matrix) {
  
  projections <- as.data.table(matrix, keep.rownames = FALSE)
  colnames(projections) <- c("tSNE1", "tSNE2", "tSNE3")
  
  projections <- data.table(principals, projections)
  projections <- projections[gazetteer[, !c("COUNTYFP")], on = "COUNTYGEOID"]
  projections
  
}


# tSNE Callback Function
epoch_callback <- function(x){
  
  # Use elapsed time to create file names
  elapsed <- as.integer(as.integer(Sys.time()) - variables$start)
  namestr <- formatC(elapsed, width = 9, format = "d", flag = "0")
  
  # Saving the data of, and illustrating, the latest tSNE estimates
  latest <- structure(matrix = x)
  tSNE3DGraph(data = latest, fileName = namestr, colours = colours)
}


# tSNE Algorithm
estimates <- tsne(distances, initial_config = NULL, k = 3, initial_dims = variables$initial_dims, max_iter = 800,
     epoch_callback = NULL, epoch = variables$epoch)
tSNE3DGraph(data = structure(matrix = estimates), fileName = "estimates", colours = colours)


